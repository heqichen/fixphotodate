# 特殊格式文件名时间提取 - 快速参考

## 概述

程序现在支持从特殊格式的文件名中自动提取时间戳并更新媒体元数据。

## 支持的格式

### 1️⃣ MA格式（图片）
**目标**: JPG/JPEG图片
**格式**: `MA<YYYYMMDDHHMMSS>***`
**例子**: `MA201203141423570096-12-000000.jpg`
**时间**: 2012-03-14 14:23:57
**实现**: v3.5
**测试**: ✅ 9/9 通过

**优先级**:
1. MA格式提取 ⭐
2. 读取现有EXIF
3. 文件名猜测
4. 目录名推断

---

### 2️⃣ video格式（MP4视频）
**目标**: MP4视频文件
**格式**: `video-<YYYY-MM-DD-HH-mm-ss>***`
**例子**: `video-2012-03-17-23-48-09.mp4`
**时间**: 2012-03-17 23:48:09
**实现**: v3.6
**测试**: ✅ 15/15 通过

**优先级**:
1. video格式提取 ⭐
2. 文件名猜测

---

## 快速参考表

| 特性 | MA格式 | video格式 |
|------|--------|----------|
| **文件类型** | JPG/JPEG | MP4 |
| **前缀** | MA | video- |
| **时间戳格式** | YYYYMMDDHHMMSS | YYYY-MM-DD-HH-mm-ss |
| **时间戳长度** | 14位数字 | 19个字符（含分隔符） |
| **分隔符** | 无 | 连字符(-) |
| **例子** | `MA201203141423570096-12-000000.jpg` | `video-2012-03-17-23-48-09.mp4` |
| **后缀支持** | 任意字符 | 任意字符 |
| **元数据更新** | EXIF DateTimeOriginal | MP4 creation_time |
| **测试用例** | 9 | 15 |
| **验证级别** | 低（14位数字格式） | 高（日期时间验证） |

---

## 用法示例

### 处理包含特殊格式文件的目录

```bash
python3 main.py /path/to/media/directory/
```

### 处理结果示例

```
2026-01-03 10:23:45 - INFO - 找到 1 个图片文件
2026-01-03 10:23:45 - INFO - 处理图片: MA201203141423570096-12-000000.jpg
2026-01-03 10:23:45 - INFO -   从MA格式文件名提取时间: 2012-03-14 14:23:57
2026-01-03 10:23:45 - INFO -   已更新图片EXIF日期

2026-01-03 10:23:45 - INFO - 找到 1 个MP4文件
2026-01-03 10:23:46 - INFO - 处理MP4: video-2012-03-17-23-48-09.mp4
2026-01-03 10:23:46 - INFO -   从video格式文件名提取时间: 2012-03-17 23:48:09
2026-01-03 10:23:47 - INFO -   已设置MP4时间戳: 2012-03-17 23:48:09
```

---

## 测试和演示

### 单元测试

```bash
# 测试MA格式提取
python3 test_ma_format.py
# 结果: 9 通过, 0 失败 ✅

# 测试video格式提取
python3 test_video_format.py
# 结果: 15 通过, 0 失败 ✅
```

### 演示脚本

```bash
# 演示MA格式处理
python3 demo_ma_format.py

# 演示video格式处理
python3 demo_video_format.py
```

---

## 处理流程

### 图片处理（JPG/JPEG）

```
JPG文件
  ↓
检查MA格式 (MA开头+14位数字)
  ↓
[成功] → 提取时间 → 更新EXIF → 完成 ✅
  ↓
[失败] → 读取现有EXIF → 有效? → 使用EXIF时间 ✅
           ↓
         [无效] → 尝试猜测时间 → 成功? → 更新EXIF ✅
                      ↓
                    [失败] → 跳过 (文件保持不变)
```

### 视频处理（MP4）

```
MP4文件
  ↓
检查video格式 (video-开头+YYYY-MM-DD-HH-mm-ss)
  ↓
[成功] → 提取时间 → 验证日期有效性 → 更新MP4元数据 → 完成 ✅
  ↓
[失败] → 尝试猜测时间 → 成功? → 更新MP4元数据 ✅
                          ↓
                        [失败] → 跳过 (文件保持不变)
```

---

## 错误处理

### MA格式错误

| 错误类型 | 处理方式 | 结果 |
|---------|---------|------|
| 不以MA开头 | 回退 | 继续其他方法 |
| 数字不足 | 回退 | 继续其他方法 |
| EXIF写入失败 | 记录警告 | 不中断处理 |
| 缺少piexif库 | 记录警告 | 跳过EXIF更新 |

### video格式错误

| 错误类型 | 处理方式 | 结果 |
|---------|---------|------|
| 不以video-开头 | 回退 | 继续其他方法 |
| 日期无效（13月） | 拒绝 | 返回None |
| 日期无效（32日） | 拒绝 | 返回None |
| 时间无效（25时） | 拒绝 | 返回None |
| 元数据写入失败 | 记录警告 | 不中断处理 |
| 缺少ffmpeg | 记录错误 | 跳过元数据更新 |

---

## 文件清单

### 核心文件
- `main.py` - 主程序（新增MA和video格式处理）

### 测试文件
- `test_ma_format.py` - MA格式单元测试 (9 cases)
- `test_video_format.py` - video格式单元测试 (15 cases)

### 演示文件
- `demo_ma_format.py` - MA格式演示脚本
- `demo_video_format.py` - video格式演示脚本

### 文档文件
- `MA_FORMAT_GUIDE.md` - MA格式完整文档
- `VIDEO_FORMAT_GUIDE.md` - video格式完整文档
- `V3.5_MA_FORMAT_SUMMARY.md` - MA实现总结
- `V3.6_VIDEO_FORMAT_SUMMARY.md` - video实现总结

---

## 版本历史

### v3.6 (当前)
- ✨ 新增video-<YYYY-MM-DD-HH-mm-ss>***格式MP4视频时间提取
- 支持MP4文件扫描和处理
- 15个单元测试 ✅
- 完整的元数据更新

### v3.5
- ✨ 新增MA<YYYYMMDDHHMMSS>***格式图片时间提取
- 9个单元测试 ✅
- 完整的EXIF更新

### v3.4
- 添加FLV视频格式支持

### v3.3
- 添加MTS视频格式支持

### v3.2
- 添加MOV视频格式支持

### v3.1
- 添加VOB视频格式支持

---

## 常用命令

```bash
# 处理包含特殊格式文件的目录
python3 main.py ./20070922_mcm/

# 处理多个目录
python3 main.py ./20070922_mcm/ ./20070923_mcm/

# 运行所有测试
python3 test_ma_format.py && python3 test_video_format.py

# 查看演示
python3 demo_ma_format.py
python3 demo_video_format.py
```

---

## 兼容性

- ✅ 100% 向后兼容
- ✅ 不影响现有文件处理
- ✅ 自动检测特殊格式
- ✅ 失败时自动回退

---

**最后更新**: 2026-01-03
**Python版本**: 3.6+
**依赖**: PIL/Pillow, piexif, ffmpeg
**状态**: ✅ 生产就绪
