# MA格式文件名时间提取功能

## 功能说明

本程序现在支持从特殊格式的图片文件名中自动提取拍摄时间，并写入图片的EXIF信息。

### 支持的文件名格式

格式: `MA<YYYYMMDDHHMMSS>***`

其中:
- `MA` - 文件名前缀标识
- `YYYYMMDDHHMMSS` - 14位时间戳，表示年月日时分秒
- `***` - 后续的任意字符（可选）

### 示例

| 文件名 | 提取的时间 | 说明 |
|--------|-----------|------|
| `MA201203141423570096-12-000000` | 2012-03-14 14:23:57 | 标准格式 |
| `MA201203141423570096-12-000000.jpg` | 2012-03-14 14:23:57 | 带扩展名 |
| `MA20201215101530.jpeg` | 2020-12-15 10:15:30 | JPEG格式 |
| `MA20000101000000.png` | 2000-01-01 00:00:00 | PNG格式 |
| `MA20231225235959photo` | 2023-12-25 23:59:59 | 有额外后缀 |

## 处理流程

当处理一个JPG/JPEG图片时，程序会按以下优先级提取时间：

1. **MA格式提取** (最优先) ⭐
   - 检查文件名是否以`MA`开头，后跟14位数字
   - 如果匹配，直接从文件名提取时间并写入EXIF
   - 这是最可靠的方式

2. **读取现有EXIF**
   - 如果图片已有EXIF拍摄时间，则使用该时间
   - 不再需要猜测或提取

3. **文件名猜测**
   - 尝试从其他文件名格式猜测时间（如YYYYMMDD_HHMM）
   - 通过相邻照片插值或前一个文件推断

4. **目录名推断**
   - 最后尝试从目录名提取日期信息

## 实现细节

### 代码位置

- `process_image()` - 主图片处理方法
- `_extract_datetime_from_ma_format()` - MA格式提取的实现

### 时间提取规则

```python
def _extract_datetime_from_ma_format(image_path: Path) -> Optional[datetime]:
    """
    从特殊格式的文件名提取时间戳：MA<YYYYMMDDHHMMSS>***
    例如：MA201203141423570096-12-000000 → 2012-03-14 14:23:57
    """
    match = re.match(r'^MA(\d{14})', filename)
    if match:
        datetime_str = match.group(1)  # YYYYMMDDHHMMSS
        return datetime.strptime(datetime_str, '%Y%m%d%H%M%S')
```

### EXIF写入

提取到时间后，程序使用`piexif`库将时间写入图片的EXIF信息：
- DateTimeOriginal (EXIF标签 36867)
- DateTime (EXIF标签 306)

## 使用示例

### 命令行运行

```bash
python3 main.py /path/to/image/directory/
```

### 日志输出示例

```
2026-01-03 10:23:45 - INFO - 处理图片: MA201203141423570096-12-000000.jpg
2026-01-03 10:23:45 - INFO -   从MA格式文件名提取时间: 2012-03-14 14:23:57
2026-01-03 10:23:45 - INFO -   已更新图片EXIF日期
```

## 测试

运行测试脚本验证MA格式提取功能：

```bash
python3 test_ma_format.py
```

测试覆盖：
- ✅ 标准MA格式
- ✅ 带文件扩展名的格式
- ✅ 各种日期时间值
- ✅ 边界值测试
- ✅ 无效格式处理
- ✅ 有额外后缀的格式

## 版本历史

### v3.4 (当前)
- ✨ 新增MA格式文件名时间提取功能
- 支持YYYYMMDDHHMMSS时间戳识别
- 自动更新图片EXIF信息
- 完整的错误处理和日志记录

## 常见问题

### Q: 如果同时有MA格式提取和现有EXIF，会怎样？
A: MA格式提取优先级更高，会覆盖现有EXIF时间。这是为了确保使用最准确的时间信息。

### Q: 文件名中数字的格式必须严格按照YYYYMMDDHHMMSS吗？
A: 是的。程序会校验时间的有效性。无效的日期（如2012-13-32）会被拒绝。

### Q: 如果MA格式提取失败会怎样？
A: 程序会自动回退到下一个优先级（读取EXIF或猜测），不会中断处理。

### Q: 支持哪些图片格式？
A: 支持JPG、JPEG、PNG、BMP、GIF、TIFF等，需要PIL库支持。

## 相关配置

需要的Python库：
- `PIL/Pillow` - 图片处理
- `piexif` - EXIF数据操作
- `pathlib` - 路径处理（标准库）
- `re` - 正则表达式（标准库）

## 贡献和改进

如果需要支持其他文件名格式，可以：

1. 在`process_image()`中添加新的提取方法
2. 在`_extract_datetime_from_ma_format()`下方添加类似的提取函数
3. 更新处理流程的优先级顺序
