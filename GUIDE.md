# 项目结构

本项目包含以下文件和目录：

## 主要文件

### `main.py`
核心处理脚本，包含 `MediaProcessor` 类，实现所有的媒体处理功能：
- 读取照片EXIF数据
- 从文件名/目录名猜测日期
- 更新照片EXIF信息
- 将AVI转换为MP4
- 设置视频元数据

**主要类：**
- `MediaProcessor`: 媒体处理主类

**主要方法：**
- `process_all()`: 处理目录中的所有文件
- `process_image()`: 处理单个图片
- `process_avi()`: 处理单个AVI文件
- `get_exif_datetime()`: 读取图片EXIF日期
- `set_exif_datetime()`: 设置图片EXIF日期
- `guess_datetime_from_filename()`: 从文件名猜测日期（带插值和最后文件推断）
- `_interpolate_datetime_from_neighbors()`: 通过相邻照片插值推断视频时间 ⭐
- `_get_datetime_from_last_file()`: 对于最后一个文件，从前一个文件推断时间 ⭐
- `convert_avi_to_mp4()`: AVI转MP4
- `set_mp4_metadata()`: 设置MP4元数据

### `requirements.txt`
Python依赖列表：
- `Pillow`: 图片处理库（读写EXIF）
- `piexif`: EXIF数据处理库

### `README.md`
项目使用说明文档

### `config.ini`
配置文件，包含转码参数、日期格式等可配置项

### `test_env.py`
环境检查脚本，验证：
- Python版本
- ffmpeg安装
- 所需Python包
- 主脚本和示例目录

### `examples.py`
使用示例脚本，演示：
- 处理单个目录
- 处理多个目录
- 手动处理单个图片
- 手动处理单个视频
- 查看目录解析的日期

### `setup.sh`
快速安装脚本（Linux/macOS）

## 数据目录

### `20070922_mcm/`
示例目录，包含：
- `S7300317.JPG` - 样本图片
- `S7300318.JPG` - 样本图片
- ... （更多图片）
- `S7300333.AVI` - 样本视频

处理后会生成：
- `S7300333.MP4` - 转换后的视频文件
- `archive/20070922_mcm/S7300333.AVI` - 移动后的原始AVI

## 使用工作流

### 1. 初始化（第一次使用）
```bash
# Linux/macOS
bash setup.sh

# 或手动安装
pip3 install -r requirements.txt
```

### 2. 验证环境
```bash
python3 test_env.py
```

### 3. 运行脚本
```bash
# 处理单个目录
python3 main.py ./20070922_mcm

# 处理多个目录
python3 main.py ./20070922_mcm ./20070923_mcm
```

### 4. 查看结果
处理完成后：
- 照片的EXIF日期已更新
- AVI文件已移动到 `archive/20070922_mcm/`
- 生成的MP4文件在原目录

## 关键特性详解

### 日期识别系统
脚本使用多层策略识别媒体创建日期，对视频文件有特殊的插值处理：

#### 对于视频文件（AVI）- 智能插值识别 ⭐⭐⭐
1. **最后一个文件检测** ⭐⭐⭐ (新增)
   - 检测当前视频是否为目录中最后一个媒体文件
   - 如果是，从前一个媒体文件（照片或视频）获取时间
   - 在该时间基础上加1分钟作为推断时间
   - 适用于数码相机最后一段拍摄的视频
   - 精度：±1分钟（由固定的1分钟增量决定）

2. **EXIF插值优先级**（准确度：最高）
   - 查找视频前后相邻的照片文件（根据文件编号）
   - 读取相邻照片的EXIF拍摄时间戳
   - 使用线性插值计算视频的精确时间
   - 示例：
     ```
     S7300332.JPG (EXIF: 2007-09-22 14:30:00) ─┐
                                              ├─ 插值
     S7300333.AVI (猜测: 2007-09-22 14:31:00) ─┤
                                              ├─ 插值
     S7300336.JPG (EXIF: 2007-09-22 14:35:00) ─┘
     ```
   - 精度：秒级，通常非常准确

3. **文件名解析**（准确度：中等）
   - 从文件名中提取时间标记（如 `_1430` 表示14:30）
   - 与目录名YYYYMMDD组合

4. **文件序列推断**（准确度：低）
   - 根据文件编号推算相对时间
   - 假设相邻文件相隔数秒至数分钟

#### 对于照片文件（JPG等）
1. **EXIF优先级**（准确度：最高）
   - 从JPG的EXIF数据读取 `DateTimeOriginal` 字段
   - 精度：秒级

2. **文件名解析**（准确度：中等）
   - 从文件名中提取时间标记（如 `_1430` 表示14:30）
   - 与目录名YYYYMMDD组合

3. **文件序列推断**（准确度：低）
   - 根据文件编号推算相对时间
   - 假设相邻文件相隔数秒至数分钟

4. **目录日期**（准确度：中等）
   - 从目录名解析YYYYMMDD格式的日期
   - 作为基础日期使用

**关键优势**：对于用数码相机连续拍摄的照片和视频，脚本能够通过前后照片的EXIF时间戳精确推断出视频的拍摄时间，通常误差不超过几秒钟。

### 视频转码设置
转码采用高质量设置：
- 编码器：H.264 (libx264)
- 质量参数：CRF=18（高质量）
- 预设：medium（平衡速度和质量）
- 音频编码：AAC

可在 `config.ini` 中调整这些参数。

### 元数据处理
- **图片**：更新EXIF中的DateTime和DateTimeOriginal字段
- **视频**：使用ffmpeg写入creation_time元数据

## 常见问题

### Q: 脚本会删除原始文件吗？
A: 不会。AVI文件会被**移动**（不是删除）到 `archive/` 目录。图片文件会被更新但保留在原位置。

### Q: 如何恢复被移动的AVI文件？
A: 在 `archive/` 目录中找到对应的目录，然后移动回原位置。

### Q: 转码速度太慢？
A: 可以在 `config.ini` 中修改 `FFMPEG_PRESET` 为 `fast` 或 `faster`。

### Q: 如何改变转码质量？
A: 修改 `config.ini` 中的 `FFMPEG_CRF` 值（默认18，范围0-51，越小质量越好）。

### Q: 脚本支持哪些格式？
A: 
- 图片：JPG, JPEG, PNG, BMP, GIF, TIFF
- 视频：AVI, MP4, MOV, MKV, FLV, WMV（转码只针对AVI）

## 技术细节

### 依赖项
- **Pillow**: 用于读取和修改图片的EXIF数据
- **piexif**: 专门的EXIF处理库，提供更好的兼容性
- **ffmpeg**: 外部工具，用于视频转码

### 编码方案
- 日期格式：ISO 8601（YYYY-MM-DD HH:MM:SS）
- 文件路径：支持绝对和相对路径
- 日志级别：INFO（可在代码中修改）

### 错误处理
脚本具有鲁棒的错误处理：
- EXIF读取失败会自动降级到文件名解析
- 转码失败会记录错误但继续处理其他文件
- 缺失依赖会给出清晰的错误提示

## 性能考虑

处理时间主要取决于：
1. **视频转码**：AVI→MP4转码是最耗时的操作
   - 1GB视频文件可能需要10-30分钟
   - 取决于分辨率、帧率和转码预设

2. **EXIF处理**：相对较快
   - 1000张图片通常需要1-2秒

3. **磁盘空间**：需要足够的空间
   - 需要既能容纳原始文件，又能容纳转码后的MP4
   - 通常需要原始AVI大小的额外空间

## 开发注意事项

### 添加新的日期识别模式
在 `guess_datetime_from_filename()` 方法中添加新的正则表达式模式。

### 修改转码参数
在 `convert_avi_to_mp4()` 方法的 `cmd` 列表中修改ffmpeg参数。

### 扩展支持的格式
修改 `IMAGE_EXTENSIONS` 和 `VIDEO_EXTENSIONS` 集合。

## 许可证
MIT License

## 作者
创建于 2024年
