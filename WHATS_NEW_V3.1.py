#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
v3.1 版本 VOB 文件支持快速参考
=====================================

本脚本演示了 v3.1 版本新增的 VOB 视频文件处理功能。
"""

# ============================================================================
# 1. VOB 视频文件处理
# ============================================================================
"""
VOB (Video Object) 是 DVD-Video 标准格式。

来源：
- DVD 光盘备份
- Adobe Premiere 等视频编辑软件
- 数字录像机（DVR）
- 家庭视频录制设备

功能：
- 自动扫描目录中的 .vob 文件
- 备份到 archive/ 目录
- 使用 ffmpeg 转换为 MP4 格式（H.264 + AAC）
- 自动推断创建时间并写入元数据

工作流程：
  source_file.vob
    ↓
  [backup] → archive/source_file.vob
    ↓
  [convert] ffmpeg -i → source_file.mp4 (H.264)
    ↓
  [infer_time] 智能推断时间戳
    ↓
  [set_metadata] 写入创建时间
    ↓
  source_file.mp4 ✓ (带时间戳)

代码示例：
  processor = MediaProcessor('./dvd_backup/')
  processor.process_all()  # 自动处理 VOB 文件
"""

# ============================================================================
# 2. VOB 转换参数详解
# ============================================================================
"""
ffmpeg VOB → MP4 转换参数：

ffmpeg -i input.vob \
  -c:v libx264       H.264 视频编码器（高压缩）
  -preset medium     编码速度：medium（平衡速度和质量）
  -crf 18           质量参数：18（0=最高, 51=最低，18=高质量）
  -c:a aac          音频编码器：AAC
  -q:a 9            音频质量：9（最高）
  -y                自动覆盖输出
  output.mp4

结果：高质量 MP4 文件，文件大小减小 50-70%
"""

# ============================================================================
# 3. 性能数据
# ============================================================================
"""
VOB 文件转换时间预估（基于现代硬件）：

文件大小 → 转换时间
100 MB   → 2-5 分钟
500 MB   → 10-20 分钟
1 GB     → 20-40 分钟
4 GB     → 80-160 分钟（完整 DVD）

磁盘空间需求（以 1GB VOB 为例）：
  原始 VOB 文件      : 1000 MB
  转换后 MP4         : 300-500 MB
  Archive 备份       : 1000 MB
  总需要磁盘空间     : 2300-2500 MB
"""

# ============================================================================
# 4. 时间推断优先级（VOB）
# ============================================================================
"""
VOB 文件的 5 层级联时间推断系统：

Level 1: 最后文件检测 (最准确)
  ├─ 检查是否为目录中最后一个媒体文件
  ├─ 找到前一个媒体文件（照片/视频/音频）
  ├─ 获取其时间戳
  └─ 加 1 分钟作为当前文件时间
  
  适用于：VOB (新增)

Level 2: EXIF 插值 (仅限视频)
  ├─ 找到相邻的两张照片
  ├─ 读取它们的 EXIF 拍摄时间
  ├─ 线性插值计算视频时间
  └─ 精度：±1 秒
  
  适用于：AVI, 3GP, VOB ✨

Level 3: 文件名模式
  ├─ YYYYMMDD_HHMM
  ├─ YYYYMMDD_HH
  └─ YYYYMMDD

Level 4: 文件序号推导
  └─ 根据编号计算相对时间

Level 5: 目录名解析
  └─ 从目录名提取 YYYYMMDD

示例场景：
  目录中的媒体文件顺序：
  IMG_001.jpg (2024-01-15 10:30:00)
  VID_002.vob (需要推断)  ← VOB 文件
  IMG_003.jpg (2024-01-15 10:32:00)

  推断结果：
  VID_002.vob → 尝试插值 → 2024-01-15 10:31:00
"""

# ============================================================================
# 5. 文件格式支持矩阵
# ============================================================================
"""
支持格式分类（v3.1）：

┌─────────────────────────────────────────────────────────┐
│ 图片文件 (读取 EXIF，推断时间）                           │
├─────────────────────────────────────────────────────────┤
│ ✓ JPG, JPEG, PNG, BMP, GIF, TIFF                        │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 视频文件 (转换为 MP4，推断时间）                          │
├─────────────────────────────────────────────────────────┤
│ ✓ AVI    → 转换 → MP4                                   │
│ ✓ 3GP    → 转换 → MP4                                   │
│ ✓ VOB    → 转换 → MP4 (v3.1 新增) ✨                    │
│ ✓ MP4    → 保留 (不转换）                               │
│ ✓ MOV, MKV, FLV, WMV → 保留                            │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 音频文件 (转换为 MP3，推断时间）                          │
├─────────────────────────────────────────────────────────┤
│ ✓ AMR    → 转换 → MP3                                   │
│ ✓ MP3    → 保留 (不转换）                               │
│ ✓ WAV, AAC, FLAC → 保留                                 │
└─────────────────────────────────────────────────────────┘
"""

# ============================================================================
# 6. 处理流程图
# ============================================================================
"""
完整处理流程（包含 VOB）：

开始
  ↓
[扫描文件]
  ├─ 图片文件 (.jpg, .jpeg, etc.)
  ├─ AVI 视频文件 (.avi)
  ├─ 3GP 视频文件 (.3gp)
  ├─ VOB 视频文件 (.vob) ← 新增 v3.1
  └─ AMR 音频文件 (.amr)
  ↓
[处理图片]
  ├─ 读取 EXIF 日期
  ├─ 如无 EXIF → 推断时间戳
  └─ 写入 EXIF
  ↓
[处理 AVI/3GP/VOB]
  ├─ 备份到 archive/
  ├─ 转换为 MP4
  ├─ 推断时间戳
  └─ 写入 MP4 元数据
  ↓
[处理 AMR]
  ├─ 备份到 archive/
  ├─ 转换为 MP3
  ├─ 推断时间戳
  └─ 写入 MP3 元数据
  ↓
完成 ✓
"""

# ============================================================================
# 7. 常见使用场景
# ============================================================================
"""
场景 1: 处理 DVD 备份
  source_dir/
  ├─ VID_001.vob
  ├─ VID_002.vob
  ├─ VID_003.vob
  └─ IMG_004.jpg
  
  运行命令：
    python main.py ./dvd_backup/
  
  结果：所有 VOB 转换为 MP4，并自动推断时间戳

场景 2: 处理混合媒体目录
  source_dir/
  ├─ IMG_001.jpg (有 EXIF)
  ├─ VID_002.avi
  ├─ VID_003.vob
  ├─ REC_004.amr
  └─ IMG_005.jpg (有 EXIF)
  
  运行命令：
    python main.py ./mixed_media/
  
  结果：
    ✓ IMG_001.jpg - EXIF 已更新
    ✓ VID_002.mp4 - 从 AVI 转换，时间已推断
    ✓ VID_003.mp4 - 从 VOB 转换，时间已推断
    ✓ REC_004.mp3 - 从 AMR 转换，时间已推断
    ✓ IMG_005.jpg - EXIF 已更新

场景 3: 批量处理多个月份的备份
  python main.py ./jan_2024/ ./feb_2024/ ./mar_2024/
  
  结果：依次处理各目录，所有媒体文件都已正确处理
"""

# ============================================================================
# 8. 故障排除
# ============================================================================
"""
常见问题和解决方案：

问题 1: ffmpeg 未找到
  错误：ffmpeg未安装，无法转换视频
  解决：
    Ubuntu/Debian: sudo apt install ffmpeg
    macOS: brew install ffmpeg
    验证：ffmpeg -version

问题 2: 转换超时
  错误：转换超时: filename.vob
  原因：VOB 文件过大或系统资源不足
  解决：
    • 尝试处理较小的 VOB 文件
    • 等待其他进程完成
    • 使用更快的预设：'-preset fast'

问题 3: 磁盘空间不足
  错误：No space left on device
  原因：临时文件占用空间过多
  解决：
    • 清理临时文件
    • 扩展磁盘容量
    • 分批处理文件

问题 4: 时间戳推断失败
  错误：无法推断 VOB 文件时间
  原因：文件名格式不符、相邻文件缺失
  解决：
    • 检查文件命名规律
    • 确保有相邻照片用于插值
    • 手动编辑元数据

问题 5: 转换后的 MP4 无法播放
  原因：播放器不支持 H.264 + AAC
  解决：
    • 安装更新的播放器
    • 使用 VLC 等通用播放器
    • 转换为其他格式
"""

# ============================================================================
# 9. v3.1 版本特点
# ============================================================================
"""
v3.1 相比 v3.0 的改变：

新增功能：
  ✓ VOB 视频文件支持
  ✓ VOB 时间推断
  ✓ VOB 转换为 MP4

保持不变：
  ✓ 图片处理
  ✓ AVI 处理
  ✓ 3GP 处理
  ✓ AMR 处理
  ✓ 时间推断算法
  ✓ 备份机制

向后兼容性：
  ✓ 100% 兼容 v3.0
  ✓ 100% 兼容 v2.1
  ✓ 100% 兼容 v2.0
  ✓ 100% 兼容 v1.0
"""

# ============================================================================
# 10. VOB 格式知识
# ============================================================================
"""
VOB (Video Object) 格式详解：

基本信息：
  文件扩张名：.vob
  标准：DVD-Video (ISO/IEC 13818-1)
  容器格式：MPEG-2 Program Stream
  
视频编码：
  编码器：MPEG-2 Video
  分辨率：720x480 (NTSC) / 720x576 (PAL)
  帧率：29.97 fps (NTSC) / 25 fps (PAL)
  码率：4-8 Mbps

音频编码：
  主要编码：MP2 (MPEG-1 Audio Layer II)
  备用编码：AC-3 (Dolby Digital)
  采样率：48 kHz
  码率：192-448 kbps

特点：
  ✓ 大文件（单个 VOB 通常 1-4 GB）
  ✓ 高质量（DVD 标准质量）
  ✓ 兼容性有限（现代设备）
  ✗ 编码效率低（文件大）

转换原因：
  → MP4 更广泛兼容
  → 文件大小更小（H.264 压缩）
  → 易于编辑和共享
  → 现代设备更好支持
"""

# ============================================================================
# 11. 性能优化建议
# ============================================================================
"""
处理大型 VOB 文件的优化策略：

1. 编码预设优化
   -preset fast    快速转换，质量稍低
   -preset medium  平衡（默认）
   -preset slow    高质量，时间更长

2. 分批处理
   # 而不是一次处理所有大文件
   python main.py ./vob_batch1/
   python main.py ./vob_batch2/

3. 并行处理（多个终端）
   terminal 1: python main.py ./dvd1/
   terminal 2: python main.py ./dvd2/
   terminal 3: python main.py ./dvd3/

4. 后台运行
   nohup python main.py ./vob_dir/ > processing.log 2>&1 &

5. 磁盘优化
   # 确保足够的可用空间
   df -h /path/to/vob_dir/

6. 减少日志输出
   # 编辑代码改为 WARNING 级别
   logging.basicConfig(level=logging.WARNING)

7. 硬件考虑
   # 使用 SSD 而非 HDD
   # 确保充足的 RAM（≥1GB）
   # 使用多核 CPU 优势
"""

# ============================================================================
# 12. VOB vs 其他视频格式
# ============================================================================
"""
VOB 与其他视频格式的对比：

┌──────────────────────────────────────────────────────────┐
│ 格式 │ 编码 │ 来源 │ 大小 │ 兼容性 │ 处理      │
├──────────────────────────────────────────────────────────┤
│ VOB  │ MPEG-2 │ DVD │ 很大 │ 低 │ 转换为 MP4 │
│ AVI  │ MPEG-4 │ 摄像机 │ 中 │ 中 │ 转换为 MP4 │
│ 3GP  │ H.263 │ 手机 │ 小 │ 低 │ 转换为 MP4 │
│ MP4  │ H.264 │ 现代设备 │ 小 │ 很高 │ 保留 │
│ MOV  │ 多种 │ 苹果设备 │ 中 │ 高 │ 保留 │
│ MKV  │ 多种 │ 通用 │ 小 │ 中 │ 保留 │
└──────────────────────────────────────────────────────────┘

选择转换为 MP4 的原因：
  ✓ 最广泛的兼容性
  ✓ 最好的压缩效率
  ✓ 最广泛的设备支持
  ✓ 编码标准化（H.264 + AAC）
"""

print(__doc__)
