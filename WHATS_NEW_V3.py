#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
v3.0 版本新增功能快速参考
==============================

本脚本概述了 v3.0 版本新增的 3GP 和 AMR 文件处理功能。
"""

# ============================================================================
# 1. 3GP 视频文件处理
# ============================================================================
"""
3GP 是常见的手机视频格式（尤其是老款手机）。

功能：
- 自动扫描目录中的 .3gp 文件
- 备份到 archive/ 目录
- 使用 ffmpeg 转换为 MP4 格式（H.264 + AAC）
- 自动推断创建时间并写入元数据

工作流程：
  source_file.3gp
    ↓
  [backup] → archive/source_file.3gp
    ↓
  [convert] ffmpeg -i → source_file.mp4
    ↓
  [infer_time] 智能推断时间戳
    ↓
  [set_metadata] 写入创建时间
    ↓
  source_file.mp4 ✓ (带时间戳)

代码示例：
  processor = MediaProcessor('./photos_2024/')
  processor.process_all()  # 自动处理 3GP 文件
"""

# ============================================================================
# 2. AMR 音频文件处理
# ============================================================================
"""
AMR 是手机录音的常见格式（Adaptive Multi-Rate 编码）。

功能：
- 自动扫描目录中的 .amr 文件
- 备份原始 AMR 文件到 archive/ 目录
- 使用 ffmpeg 转换为 MP3 格式（libmp3lame）
- 自动推断创建时间并写入元数据

工作流程：
  source_file.amr
    ↓
  [backup] → archive/source_file.amr
    ↓
  [convert] ffmpeg -i → source_file.mp3
    ↓
  [infer_time] 智能推断时间戳
    ↓
  [set_metadata] 写入创建时间
    ↓
  source_file.mp3 ✓ (带时间戳)

代码示例：
  processor = MediaProcessor('./voice_memos/')
  processor.process_all()  # 自动处理 AMR 文件
"""

# ============================================================================
# 3. 智能时间推断（新增支持 3GP 和 AMR）
# ============================================================================
"""
时间推断优先级 (5 层级联）：

Level 1: 最后文件检测 (最准确)
  ├─ 检查是否为目录中最后一个媒体文件
  ├─ 找到前一个媒体文件（照片/视频/音频）
  ├─ 获取其时间戳
  └─ 加 1 分钟作为当前文件时间
  
  适用于：3GP, AMR

Level 2: EXIF 插值 (仅限视频)
  ├─ 找到相邻的两张照片
  ├─ 读取它们的 EXIF 拍摄时间
  ├─ 线性插值计算视频时间
  └─ 精度：±1 秒
  
  适用于：3GP （AMR 不支持）

Level 3: 文件名模式
  ├─ YYYYMMDD_HHMM
  ├─ YYYYMMDD_HH
  └─ YYYYMMDD

Level 4: 文件序号推导
  └─ 根据编号计算相对时间

Level 5: 目录名解析
  └─ 从目录名提取 YYYYMMDD

示例场景：
  目录中的媒体文件顺序：
  IMG_001.jpg (2024-01-15 10:30:00)
  VID_002.3gp (需要推断)
  AUD_003.amr (需要推断)
  IMG_004.jpg (2024-01-15 10:32:00)

  推断结果：
  - VID_002.3gp → 尝试插值 → 2024-01-15 10:31:00
  - AUD_003.amr → 最后文件检测失败 → 尝试插值 → 2024-01-15 10:31:30
                → IMG_004.jpg 前的文件 → 从 VID_002 推断时间
"""

# ============================================================================
# 4. 文件格式支持矩阵
# ============================================================================
"""
支持格式分类：

┌─────────────────────────────────────────────────────────┐
│ 图片文件 (读取 EXIF，推断时间）                           │
├─────────────────────────────────────────────────────────┤
│ ✓ JPG, JPEG, PNG, BMP, GIF, TIFF                        │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 视频文件 (转换为 MP4，推断时间）                          │
├─────────────────────────────────────────────────────────┤
│ ✓ AVI    → 转换 → MP4                                   │
│ ✓ 3GP    → 转换 → MP4 (v3.0 新增)                       │
│ ✓ MP4    → 保留 (不转换）                               │
│ ✓ MOV, MKV, FLV, WMV → 保留                            │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 音频文件 (转换为 MP3，推断时间）                          │
├─────────────────────────────────────────────────────────┤
│ ✓ AMR    → 转换 → MP3 (v3.0 新增)                       │
│ ✓ MP3    → 保留 (不转换）                               │
│ ✓ WAV, AAC, FLAC → 保留                                 │
└─────────────────────────────────────────────────────────┘

转换编码参数：
  AVI → MP4：H.264 (CRF=18), AAC audio
  3GP → MP4：H.264 (CRF=18), AAC audio
  AMR → MP3：libmp3lame (q=4)
"""

# ============================================================================
# 5. 处理流程图
# ============================================================================
"""
完整处理流程：

开始
  ↓
[扫描文件]
  ├─ 图片文件 (.jpg, .jpeg, etc.)
  ├─ AVI 视频文件 (.avi)
  ├─ 3GP 视频文件 (.3gp) ← NEW
  └─ AMR 音频文件 (.amr) ← NEW
  ↓
[处理图片]
  ├─ 读取 EXIF 日期
  ├─ 如无 EXIF → 推断时间戳
  └─ 写入 EXIF
  ↓
[处理 AVI/3GP]
  ├─ 备份到 archive/
  ├─ 转换为 MP4
  ├─ 推断时间戳
  └─ 写入 MP4 元数据
  ↓
[处理 AMR] ← NEW
  ├─ 备份到 archive/
  ├─ 转换为 MP3
  ├─ 推断时间戳
  └─ 写入 MP3 元数据
  ↓
完成 ✓
"""

# ============================================================================
# 6. 常见命令
# ============================================================================
"""
处理单个目录：
  python main.py ./camera_photos_2024/

处理多个目录：
  python main.py ./jan_2024/ ./feb_2024/ ./mar_2024/

检查日志：
  python main.py ./photos_2024/ 2>&1 | tee processing.log

处理特定格式（手动编辑代码）：
  # 注释掉不需要的处理行
  # processor.process_3gp(threeGp_file)  # 跳过 3GP
  # processor.process_amr(amr_file)      # 跳过 AMR
"""

# ============================================================================
# 7. ffmpeg 质量参数解析
# ============================================================================
"""
3GP → MP4 转换：
  -c:v libx264       视频编码器：H.264（兼容性最好）
  -preset medium     编码速度：medium（平衡速度和质量）
  -crf 18            质量参数：18（0=最高, 51=最低，18 很高质量）
  -c:a aac           音频编码器：AAC
  -q:a 9             音频质量：9（最高）
  
  结果：高质量 MP4 文件，文件大小相对较小

AMR → MP3 转换：
  -c:a libmp3lame    音频编码器：LAME MP3
  -q:a 4             音频质量：4 (0=最高, 9=最低，4 是高质量）
  
  结果：高质量 MP3 文件，与原始 AMR 相比大小相似或更小
"""

# ============================================================================
# 8. 归档目录结构
# ============================================================================
"""
处理前：
  source_dir/
  ├─ IMG_001.jpg
  ├─ VID_002.avi
  ├─ VID_003.3gp          ← v3.0 新支持
  ├─ AUD_004.amr          ← v3.0 新支持
  └─ IMG_005.jpg

处理后：
  source_dir/
  ├─ IMG_001.jpg
  ├─ VID_002.mp4
  ├─ VID_003.mp4          ← 从 3GP 转换
  ├─ AUD_004.mp3          ← 从 AMR 转换
  ├─ IMG_005.jpg
  └─ archive/source_dir/
     ├─ VID_002.avi       ← 原始备份
     ├─ VID_003.3gp       ← 原始备份 (v3.0 新增)
     └─ AUD_004.amr       ← 原始备份 (v3.0 新增)

关键点：
  - 原始文件备份在 archive/ 目录
  - 转换后的文件在原目录
  - 所有文件都有时间戳元数据
"""

# ============================================================================
# 9. 错误处理和恢复
# ============================================================================
"""
常见问题和解决方案：

问题 1: ffmpeg 未安装
  错误信息：ffmpeg未安装，无法转换视频
  解决方案：
    Ubuntu/Debian: sudo apt-get install ffmpeg
    macOS: brew install ffmpeg
    Windows: 下载 ffmpeg.exe 并添加到 PATH

问题 2: 转换超时
  错误信息：转换超时: filename.3gp
  原因：文件过大或系统资源不足
  解决方案：
    - 尝试处理较小的文件
    - 等待其他进程完成
    - 增加超时时间（修改代码）

问题 3: 权限错误
  错误信息：Permission denied
  原因：无法写入目录或创建 archive/ 目录
  解决方案：
    - 检查目录权限
    - 运行 chmod u+w source_dir
    - 以高权限用户运行

问题 4: 时间戳推断失败
  错误信息：无法推断文件时间
  原因：文件名格式不符、相邻文件缺失等
  解决方案：
    - 检查文件命名规律
    - 确保有相邻照片用于插值
    - 手动编辑 EXIF 或元数据
"""

# ============================================================================
# 10. 性能优化建议
# ============================================================================
"""
处理大量文件的优化：

1. 分批处理
   python main.py ./photos_batch1/
   python main.py ./photos_batch2/
   # 而不是一次处理所有文件

2. 并行处理（多个终端）
   terminal 1: python main.py ./jan_2024/
   terminal 2: python main.py ./feb_2024/
   terminal 3: python main.py ./mar_2024/

3. 减少日志输出
   # 编辑 main.py，将日志级别改为 WARNING
   logging.basicConfig(level=logging.WARNING)

4. 预配置参数
   # 修改 convert_3gp_to_mp4() 中的 -preset 参数
   -preset fast    # 快速转换，质量稍低
   -preset slow    # 高质量，时间更长

5. 检查磁盘空间
   # 确保有足够空间用于 archive/ 和转换
   df -h source_dir/
"""

# ============================================================================
# 11. v3.0 vs v2.1 变化总结
# ============================================================================
"""
新增特性：
  ✓ 3GP 视频文件支持
  ✓ AMR 音频文件支持
  ✓ MP3 元数据写入
  ✓ 音频文件时间推断
  ✓ 扩展的媒体文件类型识别

不变特性：
  ✓ 照片 EXIF 处理
  ✓ AVI → MP4 转换
  ✓ EXIF 插值算法
  ✓ 最后文件检测
  ✓ 5 层级联推断系统
  ✓ 日志和错误处理

向后兼容性：
  ✓ 100% 兼容 v2.1
  ✓ 现有脚本无需修改
  ✓ 数据格式完全相同
  ✓ API 接口保持不变
"""

print(__doc__)
